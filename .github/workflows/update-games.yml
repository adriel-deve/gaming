name: Update Nintendo Games Data

on:
  # Executar uma vez por dia Ã s 06:00 UTC (03:00 BRT)
  schedule:
    - cron: '0 6 * * *'

  # Permitir execuÃ§Ã£o manual
  workflow_dispatch:

jobs:
  update-data:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '22'

    - name: Setup Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.13'

    - name: Install Python dependencies
      run: |
        pip install requests

    - name: Install Node dependencies
      working-directory: ./backend
      run: |
        npm install

    - name: Step 1 - Fetch Brazil prices from Nintendo API
      working-directory: ./backend
      run: |
        echo "=========================================="
        echo "STEP 1: Fetching BR prices from Nintendo API"
        echo "=========================================="
        node scraper_27_countries.js
        echo "âœ… BR prices fetched!"

    - name: Step 2 - Fill missing BR prices (estimate from US)
      working-directory: ./backend
      run: |
        echo "=========================================="
        echo "STEP 2: Filling missing BR prices"
        echo "=========================================="
        python fill_all_br_prices.py
        echo "âœ… All BR prices filled!"

    - name: Step 3 - Apply verified sales from DekuDeals
      working-directory: ./backend
      run: |
        echo "=========================================="
        echo "STEP 3: Applying verified sales"
        echo "=========================================="
        python update_sales_dekudeals.py
        echo "âœ… Sales applied!"

    - name: Step 4 - Fix BR prices with verified data
      working-directory: ./backend
      run: |
        echo "=========================================="
        echo "STEP 4: Fixing BR prices with verified data"
        echo "=========================================="
        python fix_br_prices_verified.py
        echo "âœ… BR prices verified!"

    - name: Step 5 - Update frontend data (4 regions)
      working-directory: ./backend
      run: |
        echo "=========================================="
        echo "STEP 5: Updating frontend data"
        echo "=========================================="
        python update_all_games_4regions.py
        echo "âœ… Frontend data updated!"

    - name: Check for changes
      id: check_changes
      run: |
        git diff --quiet || echo "changes=true" >> $GITHUB_OUTPUT

    - name: Commit and push if changed
      if: steps.check_changes.outputs.changes == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add -A
        git commit -m "auto: Update Nintendo prices ($(date +'%Y-%m-%d %H:%M UTC'))"
        git push

    - name: Summary
      run: |
        echo "=========================================="
        echo "âœ… DAILY UPDATE COMPLETE!"
        echo "=========================================="
        echo "ðŸ“Š Data updated at: $(date)"
        echo "ðŸŽ® Next update: Tomorrow at 06:00 UTC"
        echo "=========================================="
